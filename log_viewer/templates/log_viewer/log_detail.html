{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{% static 'log_viewer/css/log_viewer.css' %}">
<script src="{% static 'log_viewer/js/log_viewer.js' %}"></script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:log_viewer_list' %}">Log Files</a>
    &rsaquo; {{ filename }}
</div>
{% endblock %}

{% block content %}
<div class="log-viewer-container">
    <div class="log-viewer-header">
        <h1>{{ title }}</h1>
        <div class="log-viewer-controls">
            <button id="refresh-log" class="button default">Refresh</button>
            <button id="auto-refresh-toggle" class="button default">Auto-refresh: OFF</button>
            <button id="auto-scroll-toggle" class="button default">Auto-scroll: ON</button>
            <select id="log-level-filter" class="form-control">
                <option value="">All Levels</option>
                <option value="DEBUG">DEBUG</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
                <option value="CRITICAL">CRITICAL</option>
            </select>
        </div>
    </div>
    
    <div class="log-file-info">
        <p><strong>File:</strong> {{ log_file.name }}</p>
        <p><strong>Size:</strong> {{ log_file.size|filesizeformat }}</p>
        <p><strong>Modified:</strong> {{ log_file.modified|date:"Y-m-d H:i:s" }}</p>
        <p><strong>Total Lines:</strong> {{ total_lines }}</p>
        <p><strong>Showing:</strong> Lines {{ start_line }} - {{ end_line }}</p>
    </div>
    
    {% if log_lines %}
    <div class="log-content">
        <table class="log-table">
            <thead>
                <tr>
                    <th width="100">Line(s)</th>
                    <th width="80">Level</th>
                    <th width="180">Timestamp</th>
                    <th>Message</th>
                    <th width="60">Action</th>
                </tr>
            </thead>
            <tbody id="log-lines">
                {% for line in log_lines %}
                <tr class="log-line log-level-{{ line.level|lower }} {% if line.is_multiline %}multiline-entry{% endif %}" data-level="{{ line.level }}">
                    <td class="line-number">
                        {{ line.line_range }}
                        {% if line.is_multiline %}
                            <span class="multiline-indicator" title="Multi-line entry ({{ line.line_count }} lines)">ðŸ“„</span>
                        {% endif %}
                    </td>
                    <td class="log-level">
                        <span class="level-badge level-{{ line.level|lower }}">{{ line.level }}</span>
                    </td>
                    <td class="timestamp">{{ line.timestamp }}</td>
                    <td class="message">
                        <div class="message-preview">{{ line.content }}</div>
                        {% if line.is_long %}
                            <div class="message-truncated-indicator">Content truncated...</div>
                        {% endif %}
                    </td>
                    <td class="action">
                        {% if line.is_long or line.is_multiline %}
                            <button class="view-full-btn" onclick="showLogModal('{{ line.full_content|escapejs }}', '{{ line.level }}', '{{ line.timestamp }}', '{{ line.line_range }}')">View Full</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="pagination-container">
        <div class="pagination">
            {% if current_page > 1 %}
                <a href="?page=1" class="page-link">&laquo; First</a>
                <a href="?page={{ current_page|add:'-1' }}" class="page-link">&lsaquo; Previous</a>
            {% endif %}
            
            <span class="page-info">
                Page {{ current_page }} of {{ total_pages }}
            </span>
            
            {% if current_page < total_pages %}
                <a href="?page={{ current_page|add:'1' }}" class="page-link">Next &rsaquo;</a>
                <a href="?page={{ total_pages }}" class="page-link">Last &raquo;</a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="no-logs-message">
        <h2>No log entries found</h2>
        <p>The log file appears to be empty or could not be read.</p>
    </div>
    {% endif %}
</div>

<!-- Log Entry Modal -->
<div id="logModal" class="log-modal" style="display: none;">
    <div class="log-modal-content">
        <div class="log-modal-header">
            <h3 id="modalTitle">Log Entry Details</h3>
            <button class="log-modal-close" onclick="closeLogModal()">&times;</button>
        </div>
        <div class="log-modal-info">
            <span class="modal-level-badge" id="modalLevelBadge"></span>
            <span class="modal-timestamp" id="modalTimestamp"></span>
            <span class="modal-line-range" id="modalLineRange"></span>
        </div>
        <div class="log-modal-body">
            <pre id="modalContent"></pre>
        </div>
        <div class="log-modal-footer">
            <button onclick="copyToClipboard()" class="button default">Copy to Clipboard</button>
            <button onclick="closeLogModal()" class="button default">Close</button>
        </div>
    </div>
</div>

<script>
function showLogModal(content, level, timestamp, lineRange) {
    const modal = document.getElementById('logModal');
    const modalContent = document.getElementById('modalContent');
    const modalLevelBadge = document.getElementById('modalLevelBadge');
    const modalTimestamp = document.getElementById('modalTimestamp');
    const modalLineRange = document.getElementById('modalLineRange');
    
    modalContent.textContent = content;
    modalLevelBadge.textContent = level;
    modalLevelBadge.className = `modal-level-badge level-${level.toLowerCase()}`;
    modalTimestamp.textContent = timestamp;
    modalLineRange.textContent = `Lines: ${lineRange}`;
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeLogModal() {
    const modal = document.getElementById('logModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function copyToClipboard() {
    const content = document.getElementById('modalContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        // Show a brief success message
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('logModal');
    if (event.target == modal) {
        closeLogModal();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const logViewer = new LogViewer({
        filename: '{{ filename }}',
        currentPage: {{ current_page }},
        refreshInterval: {{ refresh_interval }},
        onlyRefreshWhenActive: {{ only_refresh_when_active|yesno:"true,false" }},
        autoRefreshDefault: {{ auto_refresh_default|yesno:"true,false" }},
        autoScrollToBottom: {{ auto_scroll_to_bottom|yesno:"true,false" }},
        ajaxUrl: '{% url "admin:log_viewer_ajax" filename %}'
    });
});
</script>
{% endblock %}
